<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<link href="/css/doc/jquery.signaturepad.css" rel="stylesheet">
<script src="/js/doc/jquery.signaturepad.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
canvas {
	border: 1px solid black;
	width: 260px;
	height: 100px;
}

.modal-backdrop {
	/* bug fix - no overlay */
	display: none;
}

.bigPictureWrapper{
	position: absolute;
	display: none;
	justify-content : center;
	align-items: center;
	right:38%;
	width:400px;
	height:400px;
	z-index:100;
	background:rgba(233, 236, 239, 1);
	border:2px solid gray;
}

.bigPicture{
	position:relative;
	display:flex;
	justify-content : center;
	align-items: center;
}

.bigPicture img{
	width: 300px;
	
	box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.3);
}





</style>
</head>
<body>
<div class="bigPictureWrapper">
	<div class="bigPicture">
	
	</div>
</div>


	<form method="post" action="" class="sigPad">

		<ul class="sigNav">
			<li class="drawIt"><a href="#draw-it">서명 하기</a></li>
			<li class="clearButton"><a href="#clear">지우기</a></li>
		</ul>
		<div class="sig sigWrapper">
			<div class="typed"></div>
			<canvas class="pad" width="260" height="100"></canvas>
			<input type="hidden" name="output" class="output">
		</div>
		<button type="submit" id="save">서명완료</button>
		<canvas id="signatureCanvas"></canvas>
		<button type="submit">I accept the terms of this agreement.</button>
	</form>

	<!-- Button trigger modal -->
	<button type="button" id="reportBtn" class="btn btn-primary"
		data-bs-toggle="modal" data-bs-target="#reportModal" >
		modal</button>

	<!-- Modal -->
	<div class="z-3 modal fade" id="reportModal" data-bs-backdrop="static"
		tabindex="-1" aria-hidden="true">
		<div
			class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<scr th:insert="rpt/report :: reportFragment"></scr>
			</div>
		</div>
	</div>

<!-- Button trigger modal -->
	<button type="button" id="reportInfoBtn" class="btn btn-primary"
		data-bs-toggle="modal" data-bs-target="#reportInfoModal" >
		modal</button>

	<div class="z-3 modal fade" id="reportInfoModal" aria-hidden="true" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      	<scr th:insert="rpt/reportInfo :: reportInfoFragment"></scr>
    </div>
  </div>
</div>


	<script src="js/doc/jquery.signaturepad.js"></script>
	<script th:inline="javascript">
		$(document).ready(
				function() {
					var compressedData;

					$('.sigPad').signaturePad();

					$('#save').click(
							function(event) {
								event.preventDefault(); // 폼의 기본 제출 동작을 방지

								// 서명 데이터를 JSON 형식으로 가져오기
								var signatureData = $('.sigPad').signaturePad()
										.getSignatureString();

								// 서명 데이터를 압축
								compressedData = LZString
										.compressToBase64(signatureData);

								// 압축된 데이터를 숨겨진 input에 저장
								$('input.output').val(compressedData);

								// 압축된 데이터 출력 (선택 사항)
								console.log(compressedData);

								signView(compressedData);
							});

					function drawSignature(data) {
						// Canvas / 컨텍스트
						const canvas = document
								.getElementById('signatureCanvas');
						const ctx = canvas.getContext('2d');

						// 캔버스 초기화
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						ctx.beginPath();
						for (let i = 0; i < data.length; i++) {
							const point = data[i];
							ctx.moveTo(point.mx, point.my);
							ctx.lineTo(point.lx, point.ly);
						}
						ctx.stroke();
					}

					function signView(compressedSignatureData) {
						console.log("compressedSignatureData = "
								+ compressedSignatureData);

						// 압축된 데이터 복원
						const decompressedSignatureData = LZString
								.decompressFromBase64(compressedSignatureData);

						// 복원된 서명을 JSON화
						const signatureData = JSON
								.parse(decompressedSignatureData);

						// 서명 그리기
						drawSignature(signatureData);
						console.log(signatureData);
					}

				});
		
		
		var modalData='';
		
		// 모달
		$('#reportModal').on('show.bs.modal', function (e) {     
			$('.smoothscroll.scroll-top').attr('style', 'display:none');
			$(this).find('form')[0].reset();
			$('#reportModal select option').remove();
			$('#reportModal select').append(`<option selected>유형 선택</option>`);
			$('#reportModal input[name="uploadFile"]').val('');
			$('.uploadResult .row div').remove();
		})
		$('#reportModal').on('hidden.bs.modal', function (e) {
			$('.smoothscroll.scroll-top').removeAttr('style', 'display:none');
			$('#reportModal .uploadResult .row div').remove();

		})
		$('#reportInfoModal').on('show.bs.modal', function (e) {     
			$('.smoothscroll.scroll-top').attr('style', 'display:none');
		})
		$('#reportInfoModal').on('hidden.bs.modal', function (e) {
			$('.smoothscroll.scroll-top').removeAttr('style', 'display:none');
			$(this).find('form')[0].reset();
			$('.uploadResult .row div').remove();
		})
		
		$('#reportBtn').on('click', function(e){
			
			
			// 현재 년월일 표시
			date = new Date();
		    year = date.getFullYear();
		    month = date.getMonth() + 1;
		    day = date.getDate();
			
		    $('.cur_year').html(year + '-');
		    $('.cur_month').html(month + '-');
		    $('.cur_day').html(day);
			
			
			
			
			
			$.ajax({
				url: '/rptInsert?contractNo=26',
				type :'Get',
					
				success : function(result){
				
					for(i=0; i<result.divi.length; i++){
						$('select').append(`<option>${result.divi[i]}</option>`);
						
						$('input[name="contractNo"]').val(result.contractNo);
					}
				}
						
			})
		})
		
		
			
		$('#rpt_insertBtn').on('click', function(e){
			console.log('rtp');
			
			
			if($('select').val() !== '유형 선택'){
				$('input[name=cttDivision]').val($('select').val());
			}else{ 
				$('input[name=cttDivision]').val(null);
				}
			
			
			
			
			// 폼 데이터 전송
			var formData = new FormData(document.reportInsertForm);
				
			for (const pair of formData.entries()) {
				console.log(pair[0], pair[1]);
			}
				
			$.ajax({
				url: '/rptInsertInfo',
				processData : false,
				contentType : false,
				data : formData,
				type :'Post',
				dataType:'JSON'
						
				,success : function(result){
					rptInfo(result)
					
				}
			
			})
			
		})
		
		function rptInfo(no){
			
			$.ajax({
				url: '/rptInfo?CttReportNo=' + no,
				type :'Get'
						
				,success : function(result){
					
					$('#reportModal').modal('hide');
					
					
					
					
					console.log(result);
					$('#title').html(result.title);
					if(result.accessState == 'N'){
					$('#accessState').html('미승인');
					}else{
						$('#accessState').html('승인');
					}
					$('#cttDivision').html(result.cttDivision);
					$('textarea[name="detailContent"]').val(result.detailContent);
					$('#cttReportDt').html(result.cttReportDt.substring(0, 10));
					
					
					var uploadUL = $('#reportInfoModal .uploadResult .row');

					var str = "";
				
				result.fileList.forEach(e => {
					console.log(e)
					
					
					var savePath = e.savePath.replaceAll("\\", "/")

					var fileCallPath = encodeURIComponent(savePath
							+ "/s_" + e.saveName + "_"
							+ e.originalFileName + "." + e.ext);

					str += `<div class="col-4 col-lg-4 item pl-4 my-3">`;

					var originPath = fileCallPath;

					originPath = originPath.replace(new RegExp(/\\/g),
							"/");

					str += `<img src='/display?fileName=${originPath}' class="img-fluid">`;
					str += `</div>`;
					
					
				})
				uploadUL.append(str);

					
				}
			
			})
			
		}
		
		$('#reportInfoBtn').on('click', function(e){

			
			$.ajax({
				url: '/rptInfo?CttReportNo=' + 7,
				type :'Get'
						
				,success : function(result){
					
					modalData = result;
					
					$('#reportModal').modal('hide');
					console.log(result);
					
					$('input[name="cttReportNo"]').val(result.cttReportNo);
					$('input[name="contractNo"]').val(result.contractNo);
					
					$('#title').html(result.title);
					if(result.accessState == 'N'){
					$('#accessState').html('미승인');
					}else{
						$('#accessState').html('승인');
					}
					$('#cttDivision').html(result.cttDivision);
					$('textarea[name="detailContent"]').val(result.detailContent);
					$('#cttReportDt').html(result.cttReportDt.substring(0, 10));
						var uploadUL = $('#reportInfoModal .uploadResult .row');

						var str = "";
					
					result.fileList.forEach(e => {
						console.log(e)
						
						
						var savePath = e.savePath.replaceAll("\\", "/")

						var fileCallPath = encodeURIComponent(savePath
								+ "/s_" + e.saveName + "_"
								+ e.originalFileName + "." + e.ext);

						str += `<div class="col-4 col-lg-4 item pl-4 my-3">`;

						var originPath = fileCallPath;

						originPath = originPath.replace(new RegExp(/\\/g),
								"/");

						str += `<img src='/display?fileName=${originPath}' class="img-fluid">`;
						str += `</div>`;
						
						
					})
					uploadUL.append(str);	
					

					
				}
			
			})
		})
		

		$('.uploadResult').on("click", "img", function(e){
			var obj = e.target;

			var newobj = '';
			newobj = obj.src.replace("s_", '');

			showImage(newobj);
			
		})
		
		function showImage(img){
			
			$('.bigPictureWrapper').css("display", "flex").show();
			$('.bigPicture').html(`<img src=${img}>`);
		}
		
		$('.bigPictureWrapper').on("click", function(e){
			$('.bigPictureWrapper').hide();
		})
		
		
		$('#rpt_deleteBtn').on("click", function(e){
	
		$.ajax({
			url: '/rptDelete',
			type : 'post',
			contentType : 'application/json',
			data : JSON.stringify(modalData.fileList),
			async : false
		
		})
			location.href='/test';
		})
		
		
		$('#rpt_updateBtn').on('click', function(e){
			
			$.ajax({
				url: '/rptInsert?contractNo=26',
				type :'Get',
					
				success : function(result){
				
					for(i=0; i<result.divi.length; i++){
						$('select').append(`<option>${result.divi[i]}</option>`);
						
						$('input[name="contractNo"]').val(result.contractNo);
					}
				}
						
			})
			
		})
			$.ajax({
				url: '/rptInfo?CttReportNo=' + 8,
				type :'Get'
						
				,success : function(result){
					
					modalData = result;
					
					$('#reportModal').modal('hide');
					console.log(result);
					$('#title').html(result.title);
					if(result.accessState == 'N'){
					$('#accessState').html('미승인');
					}else{
						$('#accessState').html('승인');
					}
					$('#cttDivision').html(result.cttDivision);
					$('textarea[name="detailContent"]').val(result.detailContent);
					$('#cttReportDt').html(result.cttReportDt.substring(0, 10));
						var uploadUL = $('#reportInfoModal .uploadResult .row');

						var str = "";
					
					result.fileList.forEach(e => {
						console.log(e)
						
						
						var savePath = e.savePath.replaceAll("\\", "/")

						var fileCallPath = encodeURIComponent(savePath
								+ "/s_" + e.saveName + "_"
								+ e.originalFileName + "." + e.ext);

						str += `<div class="col-4 col-lg-4 item pl-4 my-3">`;

						var originPath = fileCallPath;

						originPath = originPath.replace(new RegExp(/\\/g),
								"/");

						str += `<img src='/display?fileName=${originPath}' class="img-fluid">`;
						str += `</div>`;
						
						
					})
					uploadUL.append(str);	
			
			
			
				}
			})
		
		
		/*
		$('.modal').on('hidden.bs.modal', function (e) {
                $(this).find('form')[0].reset();
            });*/
		
	</script>
	<script src="/js/doc/json2.min.js"></script>
</body>

</html>