<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.app.usr.mapper.UserMapper">
	<!-- 사원정보 조회 -->
	<select id="selectUserInfo" resultType="UserVO">
		SELECT u.users_no
				, u.users_id
				, u.users_pw
				, u.users_email
				, u.users_birth
				, u.users_rnn
				, u.users_gender
				, u.users_name
				, u.users_phone
				, u.users_nick
				, u.users_role
				, u.users_join_dt
				, u.users_state_change_dt
				, u.users_state
				, u.file_id
				, f.save_path
				, f.save_name
				, f.original_file_name
				, f.ext
		FROM users u
			LEFT JOIN file_detail_info f
			ON u.file_id = f.file_id
		WHERE u.users_id = #{id}
	</select>
	<!-- 회원가입 시 DB중복체크 -->
	<select id="idChk" resultType="int">
		SELECT COUNT(*)
		FROM users
		WHERE users_id = #{usersId}
	</select>
	
	<select id="emailChk" resultType="int">
		SELECT COUNT(*)
		FROM users
		WHERE users_email = #{usersEmail}
	</select>
	
	<select id="nickChk" resultType="int">
		SELECT COUNT(*)
		FROM users
		WHERE users_nick = #{usersNick}
	</select>
	<!-- 사용자 회원가입 -->
	<insert id="saveUser" parameterType="com.yedam.app.usr.service.UserVO">
		<selectKey keyProperty="usersNo" resultType="Integer" order="BEFORE">
			SELECT SEQ_USERS.NEXTVAL
			FROM dual
		</selectKey>
		INSERT INTO users(users_no, users_role, users_id, users_pw, users_name
							, users_phone, users_nick, users_email, users_rnn
							, users_state, users_gender, users_birth, users_state_change_dt, file_id )
		VALUES(#{usersNo}, #{usersRole}, #{usersId}, #{usersPw}, #{usersName}
				, #{usersPhone}, #{usersNick}, #{usersEmail}, #{usersRnn}
				, 'active', #{usersGender}, #{usersBirth}, sysdate, 664 )
	</insert>
	
	<!-- 작업자 회원가입 -->
	<insert id="saveWorker">
		<selectKey keyProperty="usersNo" resultType="Integer" order="BEFORE">
			SELECT SEQ_USERS.NEXTVAL as usersNo
			FROM dual	 
		</selectKey>

		INSERT ALL 
		INTO users(users_no, users_role, users_id, users_pw, users_name, users_phone
					, users_nick, users_email, users_birth, users_rnn, users_state
					, users_gender, users_state_change_dt, file_id )
		VALUES(#{usersNo}, #{usersRole}, #{usersId}, #{usersPw}, #{usersName}
				, #{usersPhone}, #{usersNick}, #{usersEmail}, #{usersBirth}
				, #{usersRnn}, 'active', #{usersGender}, sysdate, 664 )
					
		INTO license( license_no, license_detail_no, users_no,  write_dt, file_id) 
		VALUES ( SEQ_LICENSE.NEXTVAL, #{licenseVO.licenseDetailNo}, #{usersNo}, sysdate, #{licenseVO.fileId} )

	
		<foreach item="region" collection="regionCode" separator="">
		INTO active_region( users_no, region_code ) 
		VALUES ( #{usersNo}, #{region} )
		</foreach>

	
		<foreach item="category" collection="categoryCode" separator="">
		INTO active_category( users_no, category_code )
		VALUES (#{usersNo}, #{category} )
		</foreach>
	
		SELECT *
		FROM dual
	</insert>
	
	
	<!-- 현재 로그인한 암호화된 pw조회 --> 
	<select id="selectEncPw" resultType="String">
		SELECT users_pw 
		FROM users
		WHERE users_no = #{usersNo}		
	</select>
	<!-- 비밀번호 변경 -->
	<update id="updatePw">
		UPDATE users
		SET users_pw = #{newPassword}
		WHERE users_no = #{usersNo}
	</update>
	
	
	<update id="updateUserInfo" parameterType="UserVO">
		UPDATE users
		SET file_id = #{fileId},
			users_nick = #{usersNick},
			users_phone = #{usersPhone},
			users_email = #{usersEmail}
		WHERE users_id = #{usersId} 
	</update>
	

	<!-- 후기목록 -->
	<select id="selectUserRvwList" resultType="ReviewVO">
		SELECT c.*
		FROM (	SELECT ROWNUM as rn
					, a.*	
				FROM (SELECT re.review_no 
					   , re.request_no
					   , re.write_dt
					   , re.star
					   , re.content 
					   , USERNAME(re.worker) as worker_name
					   , re.review_division
					   , FIND_COMMONCODE(rq.category_code) as category_code
					   , FIND_COMMONCODE(rq.region_code) as region_code
					  FROM review re
					      JOIN request rq
				  	      ON re.request_no = rq.request_no
					  WHERE re.writer = #{writer}
					  ORDER BY re.write_dt desc 
					  ) a 
			<where>
				<if test="type != ''.toString">
					AND category_code = #{type}
				</if>
				<if test="keyword != ''.toString">
					AND region_code = #{keyword}
				</if>
			</where>
			  ) c
		 <![CDATA[
		 WHERE c.rn <= #{pageNum} * #{amount} AND
		 	   c.rn > (${pageNum} -1 ) * #{amount}
		 ]]>
	</select>
	<!-- 의뢰목록 -->
	<select id="selectUserReqList" resultType="RequestVO">
	   SELECT c.*		  
	   FROM ( 
   	   		 SELECT ROWNUM as rn
   	   		 		, a.*
   	   		 FROM ( SELECT request_no
						   , title
						   , category_code
						   , FIND_COMMONCODE(category_code) as category_code_nm
						   , request_state
						   , FIND_COMMONCODE(request_state) as request_state_nm
						   , file_id
						   , write_dt
					FROM request
					WHERE requester = #{usersNo}
					ORDER BY write_dt 	desc ) a 
			<where>
			<if test="type != ''.toString">
				AND category_code = #{type}
			</if>
			<if test="keyword != ''.toString">
				AND request_state = #{keyword}
			</if>
			</where>) c
		<![CDATA[
		WHERE c.rn <= #{pageNum} * #{amount} AND
			  c.rn > (#{pageNum} -1 ) * #{amount}
		]]>
	</select>
	<!-- 회원 탈퇴 -->
	<update id="updateUserState" parameterType="UserVO">
		UPDATE users
		SET users_state = 'quit'
		WHERE users_id = #{usersId}
	</update>
	
	<select id="getTotalReviewCount" resultType="int">
		SELECT COUNT(*)
		FROM (SELECT re.star
			   , re.content 
			   , USERNAME(re.worker) as worker_name
			   , re.review_division
			   , FIND_COMMONCODE(rq.category_code) as category_code
			   , FIND_COMMONCODE(rq.region_code) as region_code
			  FROM review re
		    	  JOIN request rq
		    	  ON re.request_no = rq.request_no
			  WHERE re.writer = #{writer})
	</select>
	
	<select id ="getTotalRequestCount" resultType="int">
		SELECT COUNT(*)
		FROM (SELECT request_no
					   , title
					   , category_code
					   , FIND_COMMONCODE(category_code) as category_code_nm
					   , request_state
					   , FIND_COMMONCODE(request_state) as request_state_nm
					   , file_id
				FROM request
				WHERE requester = #{usersNo})
	</select>

	<sql id="findWorker">
	   WHERE users_role = 'ROLE_WORKER'
	   <if test="categoryCode != null and categoryCode.size != 0">   
	    AND EXISTS (SELECT 1
                 FROM active_category ca
                WHERE ca.users_no = users.users_no
                AND category_code
	    <foreach item="item" index="index" collection="categoryCode"
	        open=" in (" separator="," close=")" >
	          #{item}
        </foreach>)
      </if>
      <if test="regionCode != null and regionCode.size != 0">
        AND EXISTS(SELECT 1
           FROM active_region re
           WHERE re.users_no = users.users_no
           AND region_code 
        <foreach item="item" index="index" collection="regionCode"
	        open=" in (" separator="," close=")" >
	          #{item}
        </foreach>)
      </if>
	</sql>
	
	<!-- 작업자 찾기 -->
	<select id="selectFindWorkerList" parameterType="UserVO">
		SELECT c.*		  
   	   	FROM ( SELECT ROWNUM as rn
   	   		 		  , a.*
			   FROM (SELECT *
				     FROM users
				    
				     <include refid="findWorker"></include>		
				     
				     ORDER BY users_join_dt DESC ) a 
			  ) c
	    <![CDATA[
 	    WHERE c.rn <= #{pageNum} * #{amount} AND 
		      c.rn > (#{pageNum} -1 ) * #{amount} 
	    ]]>
	</select>
	
	<select id="getTotalWorkerCount" resultType="int">
		SELECT COUNT(*)
		FROM (SELECT *
			  FROM users
			  <include refid="findWorker"></include>)
	</select>
	

</mapper>